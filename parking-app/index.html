<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parking</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#222222" />

  <style>
    html, body { height: 100%; margin: 0; padding: 0; background:#fff; }
    #appFrame{
      width:100%;
      height:100%;
      border:0;
      display:block;
    }
  </style>
</head>

<body>
  <!-- Tu app real antigua (NO se toca) -->
  <iframe id="appFrame" src="../parking.html"></iframe>

  <script>
    // 1) Registrar service worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
    }

    // 2) Permiso notificaciones (se pide solo cuando guardas aparcamiento)
    async function asegurarPermisoNoti() {
      if (!("Notification" in window)) return false;
      if (Notification.permission === "granted") return true;
      if (Notification.permission === "denied") return false;
      const p = await Notification.requestPermission();
      return p === "granted";
    }

    // 3) Mostrar notificación "Buscar coche" con coords (IMPORTANTE: lat/lng)
    async function notificarBuscarCoche(lat, lng) {
      const ok = await asegurarPermisoNoti();
      if (!ok) return;

      const reg = await navigator.serviceWorker.ready;

      await reg.showNotification("Buscar coche", {
        body: "Toca para abrir Google Maps",
        tag: "buscar-coche",
        renotify: true,
        data: { lat, lng } // ✅ ahora coincide con el service-worker
      });
    }

    // 4) Leer coords desde el iframe (busca "38.123, -0.456" en estadoBox)
    function leerCoordsDesdeIframe(iframe) {
      try {
        const doc = iframe.contentDocument;
        if (!doc) return null;

        const box = doc.getElementById("estadoBox");
        if (!box) return null;

        const txt = (box.textContent || "").trim();
        const m = txt.match(/(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)/);
        if (!m) return null;

        const lat = parseFloat(m[1]);
        const lng = parseFloat(m[2]);
        if (Number.isNaN(lat) || Number.isNaN(lng)) return null;

        return { lat, lng };
      } catch {
        return null;
      }
    }

    // 5) Hook SIN tocar parking.html:
    //    - confirm() => siempre SI durante guardar
    //    - alert() => silencioso durante guardar
    //    Así no tienes 3 ventanas de "Aceptar"
    function engancharGuardar(iframe) {
      try {
        const w = iframe.contentWindow;
        if (!w || typeof w.guardarParking !== "function") return;

        if (w.__fabioHookedParking) return;
        w.__fabioHookedParking = true;

        const originalGuardar = w.guardarParking.bind(w);

        w.guardarParking = async function() {
          // Guardamos handlers originales
          const oldConfirm = w.confirm;
          const oldAlert = w.alert;

          // ✅ Durante el guardado: confirm siempre "sí" y alert no molesta
          w.confirm = () => true;
          w.alert = () => {};

          let r;
          try {
            r = await originalGuardar();
          } finally {
            // Restaurar handlers originales SIEMPRE
            w.confirm = oldConfirm;
            w.alert = oldAlert;
          }

          // Espera un poco para que estadoBox se actualice
          setTimeout(() => {
            const coords = leerCoordsDesdeIframe(iframe);
            if (coords) notificarBuscarCoche(coords.lat, coords.lng);
          }, 350);

          return r;
        };
      } catch {}
    }

    // 6) Atajos de icono (long-press):
    //    - #aparcar => guarda y crea notificación
    //    - #buscar  => abre maps desde notificación ya existente (si hay coords)
    function ejecutarAtajoHash(iframe) {
      const h = (location.hash || "").toLowerCase();

      try {
        const w = iframe.contentWindow;
        if (!w) return;

        if (h === "#aparcar") {
          if (typeof w.guardarParking === "function") w.guardarParking();
        }

        if (h === "#buscar") {
          const coords = leerCoordsDesdeIframe(iframe);
          if (coords) notificarBuscarCoche(coords.lat, coords.lng);
        }
      } catch {}
    }

    const iframe = document.getElementById("appFrame");
    iframe.addEventListener("load", () => {
      engancharGuardar(iframe);
      ejecutarAtajoHash(iframe);
    });

    window.addEventListener("hashchange", () => ejecutarAtajoHash(iframe));
  </script>
</body>
</html>
